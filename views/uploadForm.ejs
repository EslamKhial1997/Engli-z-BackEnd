<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Video</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      body {
        height: 100vh !important;
        overflow: hidden;
        background: rgb(238, 174, 202);
        background: radial-gradient(
          circle,
          rgba(238, 174, 202, 1) 0%,
          rgba(148, 233, 148, 1) 100%
        );
        font-family: "Cairo", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      input[type="file"] {
        display: none;
      }
      .customFileInput {
        background-color: #f0f0f0;
        padding: 10px;
        cursor: pointer;
      }
      .btn {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      .spinner-border {
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        width: 15px;
        height: 15px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .rowBG {
        background: radial-gradient(
          circle,
          rgba(228, 228, 228, 0.582) 0%,
          rgba(71, 71, 71, 0.555) 100%
        );
      }
     
      .containerVideo {
        position: relative;
      }
      .labelUpLoad {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .labelIcon {
        font-size: 120px;
        color: #cccccc1c;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .labelIcon:hover {
        color: #9292929d;
      }
      @media (max-width: 779px) {
        .labelIcon {
          font-size: 60px;
        }
      }
      
      .fitContent{
        height: 100vh !important;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div
      class="container d-flex align-items-center p-2"
      style="min-height: 100vh; width: 100%"
    >
      <div class="row w-100 bg-body-tertiary rowBG rounded m-0">
        <form id="uploadForm" class="col-lg-9 mb-3">
          <div class="mt-5 containerVideo">
            <video
              id="videoPreview"
              style="width: 100%; height: auto; border: 1px solid #ccc"
              controls
              class="rounded"
            ></video>
            <label class="labelUpLoad" for="video"
              ><i class="bi bi-plus-lg labelIcon"></i
            ></label>
          </div>
          <div class="d-flex justify-content-center gap-3">
            <div>
              <input
                type="file"
                id="video"
                name="video"
                accept=".mp4"
                onchange="handleFileChange(event)"
              />
              <div id="error" class="text-danger" style="display: none">
                Please upload a valid video file.
              </div>
            </div>
            <div style="text-align: center">
              <button
                type="submit"
                class="btn btn-success"
                disabled
                id="submitBtn"
              >
                رفع الفيديو
                <i class="bi bi-upload"></i>
                <span
                  class="spinner-border"
                  style="display: none"
                  id="spinner"
                ></span>
              </button>
            </div>
          </div>
        </form>
        <div
          dir="rtl"
          class="col-lg-3 justify-content-center align-items-center pt-3 rounded bg-light fitContent"
          style="height: fitContent"
        >
        <div class="progress mx-3" style="display: none" id="uploadProgress">
          <div
            class="progress-bar bg-success"
            role="progressbar"
            style="width: 0%"
            id="progressBar"
          ></div>
        </div>
          <h3 class="text-center text-success">بيانات المحاضرة</h3>
          <div class="text-end d-flex flex-column p-3">
            <div class="my-2">
              <span class="fw-bolder text-success ms-2">اسم المحاضرة :-</span
              ><span><%= lecture.lecture %></span>
            </div>
            <div class="my-2">
              <span class="fw-bolder text-success ms-2">وصف المحاضرة :-</span
              ><span><%= lecture.description %></span>
            </div>
            <div class="my-2">
              <span class="fw-bolder text-success ms-2">سعر المحاضرة :-</span
              ><span><%= lecture.price %></span>
            </div>
            <hr class="text-success" />
            <div class="my-2">
              <span class="fw-bolder text-success ms-2">اسم الفصل :-</span
              ><span><%= lecture.section.name %></span>
            </div>
            <div class="my-2">
              <span class="fw-bolder text-success ms-2">وصف الفصل :-</span
              ><span><%= lecture.section.description %></span>
            </div>
            <hr class="text-success" />

            <div class="my-2">
              <span class="fw-bolder text-success ms-2">الصف :-</span
              ><span><%= lecture.section.class.name %></span>
            </div>
            <button type="button" class="btn btn-success mt-3">
              تعديل المحاضرة <i class="bi bi-pencil-square"></i>
            </button>
          </div>
         
        </div>
      </div>
    </div>
    <script>
      let video = null;
      let uploadInProgress = false;

      // عند اختيار الفيديو
      function handleFileChange(event) {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = false;
        const file = event.target.files[0];

        if (file && file.type === "video/mp4") {
          const videoPreview = document.getElementById("videoPreview");
          videoPreview.src = URL.createObjectURL(file); // عرض الفيديو المُختار
          video = file; // تخزين الملف
          document.getElementById("error").style.display = "none"; // إخفاء رسالة الخطأ
        } else {
          document.getElementById("error").style.display = "block"; // إظهار رسالة الخطأ إذا لم يكن ملف فيديو
        }
      }

      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (event) {
          console.log(event);
          
          event.preventDefault();
          const submitBtn = document.getElementById("submitBtn");
          const spinner = document.getElementById("spinner");
          const progressBar = document.getElementById("progressBar");
          const uploadProgress = document.getElementById("uploadProgress");

          if (video && !uploadInProgress) {
            spinner.style.display = "inline-block";
            submitBtn.disabled = true;
            uploadProgress.style.display = "block";

            uploadInProgress = true;

            axios
              .put(
                `https://video.bunnycdn.com/library/<%= libraryID %>/videos/<%= guid %>`,
                video,
                {
                  headers: {
                    "Content-Type": "application/octet-stream",
                    AccessKey: "<%= apiKey %>",
                  },
                  onUploadProgress: function (progressEvent) {
                    const percentCompleted = Math.round(
                      (progressEvent.loaded * 100) / progressEvent.total
                    );
                    progressBar.style.width = `${percentCompleted}%`;
                    progressBar.textContent = `${percentCompleted}%`;
                  },
                }
              )
              .then((response) => {
                const formData = new FormData();
                formData.append("video", true);
                axios.put(
                  `http://localhost:3000/api/v1/lecture/<%= lecture._id %>`, // مسار المحاضرة
                  formData,
                  {
                    headers: {
                      "Content-Type": "multipart/form-data",
                      Authorization: "Bearer <%= token %>",
                    },
                  }
                );
                document
                  .querySelectorAll(".modal")
                  .forEach((modal) => modal.remove()); // إزالة النوافذ السابقة

                const modalHtml = `
          <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="text-center">
                  <h4 class="modal-title my-3 d-block text-success" id="successModalLabel">تم رفع الفيديو بنجاح وجاري المعالجة</h4>
                  <h6 class="modal-title my-3 d-block">متوسط مدة معالجه الفيديو 15 دقيقة لكل ساعة</h6>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-success" data-bs-dismiss="modal">إغلاق</button>
                </div>
              </div>
            </div>
          </div>
        `;
                document.body.insertAdjacentHTML("beforeend", modalHtml);
                const successModal = new bootstrap.Modal(
                  document.getElementById("successModal")
                );
                successModal.show();

                spinner.style.display = "none";
                submitBtn.disabled = false;
                uploadProgress.style.display = "none";
                uploadInProgress = false;
              })
              .catch((error) => {
                document
                  .querySelectorAll(".modal")
                  .forEach((modal) => modal.remove()); // إزالة النوافذ السابقة

                const modalHtml = `
          <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="text-center">
                  <h4 class="modal-title my-3 d-block text-danger" id="errorModalLabel">خطأ في رفع الفيديو</h4>
                </div>
                <div class="modal-body">
                  <p class="text-center">${
                    error.response?.data?.message ===
                    "The video has already been uploaded."
                      ? "تم رفع فيديو من قبل للمحاضرة ولايمكن رفع اكثر من فيديو"
                      : "حدث خطأ أثناء رفع الفيديو. يرجى المحاولة مرة أخرى."
                  }</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">إغلاق</button>
                </div>
              </div>
            </div>
          </div>
        `;
                document.body.insertAdjacentHTML("beforeend", modalHtml);
                const errorModal = new bootstrap.Modal(
                  document.getElementById("errorModal")
                );
                errorModal.show();

                spinner.style.display = "none";
                submitBtn.disabled = false;
                uploadProgress.style.display = "none";
                uploadInProgress = false;
              });
          }
        });
    </script>
  </body>
</html>